\newpage

# 初心者のための波形解析
ここまで実践を行ってきましたが、ブラックボックスでした。
でも、理解する努力はすべきでしょう。ここから理論編に入ります。

内容は高校数学でギリギリやれますし工学部二年生は大抵理解しています[^kougaku]が、
初心者には結構難しいです。また、本書はあんま頭のいい人が書いてるわけじゃないです。
だから、ここでは物凄くざっくり(やや不正確な)解説をします。

[^kougaku]:工学部生は目をそらさないでいてもらおうか

## 波形解析で得たいものと、必要な変換
脳波や脳磁図を解析して貴方は何を得たいでしょうか？
脳波や脳磁図の特定の波長…例えばα波、β波、γ波等の強さを求めたいですね！それもミリ秒単位で！
また、どのくらい位相が揃っているかとかも見たいです。波と波の関係性とかもみたいですね。
なので、必要なのは下記を兼ね備えたデータです。

- 波の強さ
- 波の位相
- 波の位置(ミリ秒単位)
- 注目した周波数以外は無視できる
- 波と波の関係性

波というものは位相があります。出っ張りもあれば凹みもあって、しかもいろいろな波が
重なっていたりして定量化しにくいです。特定の周波数の波の出っ張りと凹みを
両方同じように評価するにはどうすればいいでしょう？

これらを実現するのが周波数解析です。本当は色々な種類の周波数解析があるのですが、
ここでは以下の3つの解析を解説しようと思います。

- フーリエ変換
- Wavelet変換
- ヒルベルト変換

## フーリエ変換とは
調べたい波を、全てsinとcosだけで表してしまうやりかたです。
周波数ごとに長いsin,cos波を大きくしたり小さくしたりしながら当てはめます。
要するに、周波数ごとに
$Acosx + Bsinx$
という形に直していきますが、実はもう一寸スマートなやり方があって
$Acosx + Bisinx$
という複素数の形式(!?)に落とし込んでいくのを目指します。
理由は波の強さ、位相を観察するためには複素数のほうが都合がいいからです。

## ShortTimeフーリエ変換
sinやcosは未来永劫続く波です。そして、実際の波は未来永劫続く波ではないです。
無限に続く波と有限の波を掛け算するのは厳しいですよね？
そこで、有限の波を「この波は実は繰り返し起こってて、実は無限なんだ！」
と嘘こくのがShortTimeフーリエ変換です。
有限の波の最初と最後がブツンと切れると凄く都合が悪いので、
そこは緩やかに減衰させておいて(Taper)その波が続くものと仮定して変換していきます。

## Wavelet変換とは
sinもcosも未来永劫絶対に減衰しない波であるため、不規則な波のフーリエ変換は元来きついです。
「一部を無理やり切り取ってきて、切り取った波が永遠に続く波と
想定した上で変換すること」は一応可能でも、実は解析結果が凄く荒くなります。[^hukakutei]
そこで、フーリエ変換にほんの少しの細工を施して時間軸を加味したのが
Wavelet変換です。

[^hukakutei]: 短い時間で解析すると時間的には細かく解析できるけど、周波数の詳しい所が見れなくなります。これをフーリエ変換の不確定性原理と言います。量子力学にも出てくる言葉ですが、実は同じことなのです。

理解するためにはフーリエ級数を理解する必要があります。

## ヒルベルト変換
上記とはちょっと違った風な解析ですが、実用上の性質や使い方はwavelet変換によくにています。
wavelet変換は一つの波から「実数部分と虚数部分を抽出してくる変換」
と言えますが、ヒルベルト変換は「元の波から架空の虚数軸部分を作っちゃう変換」みたいなイメージです。
架空の虚軸を出してくればパワーも位相も出し放題ですね。
内容的には逆フーリエ変換を足し算とすると、ヒルベルト変換は引き算みたいなものです。
計算の方法は簡単で、中学校の頃に習う$1/x$という風な双曲線を元の波に掛け算してあげるだけです。
この理屈に関しては付録で述べます。

## フーリエ級数

早速ですが、フーリエ変換の時、元の波は下記のように表します。

$$f(x)=a_0+\sum_{k=1}^{\infty}(a_n\cos{\frac{2\pi nt}{T}}+b_n\sin{{\frac{2\pi nt}{T}}})$$

これは何かというと、波を変換している式です。解説します。それぞれ…

- $f(x)$:元の波を表す式
- $a_0$:波のベースの高さ
- t:時間
- n:解析したい周波数に対応した変数
- T:周期(任意の定数)
- 右辺:特定周波数の波を表す式

かなり複雑な式っぽいですが、$\sum$の中を御覧ください。
解析したい周波数が変数として与えられてます。これは、特定の周波数だけにしか対応しないのです。

大抵の波はこの単純な波の足し算で説明することが出来るのです。

実はこの方程式を積分したりして解けば、各nに対するaもbも算出することが出来ます。
右辺全体をフーリエ級数、aとbをフーリエ係数と言います。
この式によって規則的なほとんど全ての波を別形式に書き換えられます。
凄いですね！ですが、それだけでは面白くありません。
波をこのように別の式に書き換えた所で僕達がほしい
「波の強さ」「波の位相同期性」「波の位置」の情報がないからです。
なので、上の式を複素数を使って変換して公式を求めます。

## 複素フーリエ級数
高校数学の複素数平面を覚えているでしょうか？全ての二次元の座標は
複素数平面上で下記の式によって表現できます。
$$r(cos\theta+isin\theta)$$
高校時代に習った極座標みたいな何かですね！おぼろげに覚えているかも知れません。
最終的にはこの様な形に成れば、波の強さも位相も分かるはずです。

さて、貴方はオイラーの公式をご存知でしょうか？
この世で最も美しく偉大な公式の一つです。(実際人気が高い)
高校数学でギリギリ出てきます。下記です。

$$e^{i\theta}=cos\theta+isin\theta$$

何度見ても美しい公式ですね。[^toushiki]崇めて下さい。証明はググってください。
これは美しいだけでなく役に立ちます。まずはこのオイラーの公式による変換を考えます。

端折りますが、オイラーの公式を変形するとsinとcosをeとiで表現することが可能です。
$$cos \theta = \frac{e^{i\theta} + e^{-i\theta}}{2}$$
三角関数なんかいらんかったんや。
というわけで、フーリエ級数の式からsinとcosを排除できます。式を弄くり倒すと、
$$f(x)=\sum_{n=-\infty}^{\infty}C_ne^{i\pi t/T}$$
と変形できます。Cnは変換a,bを複素数でまとめたものです。
この式の右辺を複素フーリエ級数といいます。
フーリエ変換とはフーリエ係数を求める計算のことです。

$f(x)$は元の波、$e^{i\pi t/T}$はオイラーの公式を見ると…半径1の円ですね。

ここで知りたいのはCnです。Cnを求めるにはやはり高校数学によって下記のように書き換えられます。
$$C_n=\frac{1}{T}\int_{-T/2}^{T/2}x(t)e^{-2\pi nt/T}$$
$f(x)$は脳波や脳磁図の結果ですので、フーリエ変換は
脳波や脳磁図に絶対値1の複素数を掛け算して積分する操作といえそうです。

plotすると勉強になるかも知れません。i乗とか実際に計算するのはアレなので、実際の計算をする時も
オイラーの公式で展開…と言いたいところなのですが、
python3なんかは複素数の演算ができるので、$e^i$を計算できたりします。凄いですね！！！

というわけで、上の式をそのままpython3流に書けばフーリエ変換は
自分でコーディングすることが出来るわけです。でも、僕は自分ではしないです。
既にそれをする為の最適化されたパッケージは開発されているからです。[^saihatu]

ところで、フーリエ変換にはFFTという超速いアルゴリズムがあります。
これは畳み込みの定理を組み合わせることでwavelet変換にも応用できます。
結果は変わらないので実際の計算をする時は使うといいでしょう。

![再掲。Morlet Waveletの2Dプロット](img/wavelet_base.png)

![再掲。3Dプロット](img/3d_wavelet_base.png)

[^saihatu]:既に作られているものをもう一回作る無駄のことを、業界では「車輪の再発明」と言い、性能が落ちる車輪の再発明のことを「四角い車輪の再発明」といいます。

## 結局何をしているのか
要するに

$波=特定の周波数の波1+特定の周波数の波2+特定の周波数の波3...$

$特定の周波数の波 = 複素数の定数 * 基準の波$

という感じに変えていくだけの計算です。各周波数の数列さえわかれば波が表せます。
で、この定数を複素数にしたものが複素数版フーリエ級数。
複素数だから「定数」の絶対値や位相が計算しやすい、ということです。

さて、今あなたは周波数ごとに
$A + Bi$ または $(r,\theta)$ という形の複素数を得ることが出来ています。
これをどう料理していくかが次の問題です。
ここまでくれば高校の複素数です。

## スペクトル解析
得たかったものは何だったか思い出しましょう。複素数から「絶対値、位相」が分かるというのは
高校時代に数学をしたことのある人は明らかでしょう。
では、脳波の強さとは何でしょうか？それはエネルギーみたいなものです。
即ち、絶対値の二乗に他なりません！
(物理の人に怒られる表現。実際はそう簡単でもない。)
脳波の位相はもちろん、上記の複素数の位相成分ですね。

フーリエ変換で出て来る数値(フーリエなら係数に相当するやつ)は
スペクトルと業界(脳波以外でも波を使う業界なら全て)で呼ばれています。
特に、自分自身に自分自身を掛け算したものの積分は「パワースペクトル」といいます。
$f(\omega)$の絶対値の二乗が力(パワー)、そして位相がそのまま位相です。

この、パワースペクトルの時間単位の平均値が
パワースペクトル密度(PSD)と言われ、脳波解析の結果の一つです。

では、位相についてはどうするでしょうか？
一つの脳波の位相を取り出したところで意味はありません。
位相の良いところは他の波とリズムが揃っているか調べられる所にあります。
「毎回同じ位相を取り続けるかどうか」であったり、
「他の場所の位相とどのくらい差があるか」であったり、色々わかります。

毎回同じかどうかはPhaseLockingFactorとかInterTrialCoherenceと呼ばれ、
それぞれPLF、ITCと略されます。(意味は同じです)
他の場所の位相とどのくらい差があるかはPhaseLockingValueと呼ばれ、
PLVと略されます。(後で書きますが、PLVは頑健ではないので別の指標を使います)

さて、実際の計算は大したことはありません。複素数 $A + iB$ について考えてみましょう。
これの絶対値は $ (A + iB)(A - iB) $であることは自明です。
すなわち、複素共役同士を掛け算したものです。
これ、自分自身をかけ合わせると位相が0になりますが、
他の波の複素共役と掛け合わせると位相の引き算になるのです。
コネクティビティはこういうのを使っていきます。

さて、これまで「複素共役を掛け算して積分したもの」がいっぱい出てきました。
長いので、よく下記のように略されます。
Sxx (xとx、つまり自分と自分の関係、パワースペクトル)
Sxy (xとy、つまり自分と他人の関係、クロススペクトル)
以下、このように書いていきます。

## そしてwavelet変換へ

一旦話を戻し、まずはPowerを考えます。
フーリエ変換の時点では周波数ごとの複素数が一つづつありました。
これでは時間の次元が失われていますね。いつそのPowerだったんだよと思います。
この理由は、フーリエ変換に使うsinとcosが永遠に続く波であるからです。
永遠に続く波を使えば、そりゃ時間軸は表現できるわけ無いです。

それを解決するのがwavelet変換です。
時間軸を表現するためにものさしに使うものは減衰する波の必要があります。
減衰させるには色々あるのですが、Gabor Waveletでは以下のようにします。


$$c\sigma \pi^{\frac{-1}{4}}e{\frac{-1}{2}t^2}e^{i\sigma t}$$
この、左側がフーリエ変換のためのやつ、右に付け加えたのが減衰するやつ。

こんな感じの式に色々と定数を付けたのが**Gabor Wavelet**です。

何故定数をつけるかというと、掛け算するときに掛け合わせるものの
絶対値が1じゃないとエネルギーを計算するのが超面倒だからです。
くるくる回りながら減衰する波です。

実際は、これはWaveletとしては結構お粗末なんだそうです。
こいつに引き算を付け加えてスケールしても歪まないようにしたのが
かの有名な**MorletWavelet**です。

$$c\sigma \pi^{\frac{-1}{4}}e{\frac{-1}{2}t^2}(e^{i\sigma t}-\kappa \sigma)$$

$\kappa$は$\sigma$から導かれる定数です。詳しくはググれ。
ちなみに、これは他にも色々あるやり方の一つです。

Wavelet変換も計算結果が複素数平面として出てきますから、
さっきと同じようにPowerと位相が分かるはずです。しかも、時間別に！

初めてフーリエ級数とか聞いた人はここまで読んで意味がわからなかったと思います。
そんな人には高校数学の美しい物語の複素フーリエ級数関連の記事をお勧めします。

[^toushiki]:ちなみに、$\theta$が1の場合はオイラーの等式と言います。美しいです。

## wavelet逆変換とbandpass filter

上記のようにwavelet変換は数値を出すのに応用できるのですが、
これは実はbandpass filterモドキにも応用することが出来ます。
何故なら、周波数を分けちゃう事ができるのと、Wavelet変換は逆変換が出来るからです。
手順としては、Wavelet変換したものの中から欲しい周波数帯域を選んで、
Wavelet逆変換を行えばbandpass filterの一種みたいなものになります。
だから、意外とバンドパスフィルタを先にかけないと駄目ということもないわけです。
ちなみに、これは世間でよく用いられているbandpass filterとはちょっと違います。

## GMWについて

### MorletWaveletとは

$$\Psi(t) = c\sigma \pi^{-\frac{1}{4}}e^{\frac{-1}{2}t^2}(e^{i\sigma t}-\kappa \sigma)$$

![morlet.png](img/morlet.png)
青が実軸、橙が虚軸です。

括弧の中に引き算が入りました。Morlet Waveletです。[^morlet]

でも、これ、図は綺麗でも式の見た目的に凄く気持ち悪いですよね？
実際に$\sigma$を小さい値にしてみるとガウシアンな曲線がグチャッと潰れて
実軸小さすぎで虚軸が大きすぎな実に気持ち悪い状態になります。
その結果、**パラメータによっては波の真ん中よりも周辺の方が過大評価されてしまいます。**
![morlet1.png](img/morlet1.png)

青が絶対値、橙が実軸、緑が虚軸です。

フーリエ変換に時間軸にガウシアンな関数を畳み込んで時間軸を加え、
歪みを取り除いたのに こうなってしまっては何のために
ガウシアンにしたのかさっぱりわからないですね🤔

# 気持ち悪さ対策
**$\sigma$を大きく取ればMorletWaveletとGaborWaveletは近似され、ほぼ重なります。**
下のプロットを見ても明らかでしょう。
時間解像度を犠牲にすれば全然問題ないね！
実際、僕も$\sigma=7$のMorletWaveletを愛用しており、実用上全く問題ないです。
良かったね！解散！
↓$\sigma$が7のGaborとMorletの比較。

![morletvsgabor.png](img/morletvsgabor.png)
重なって線が一本しか見えない！

…でも、根本的な解決になっていませんね。
そもそも$\sigma$が小さい場合はどうすれば良いのでしょうか…。
この場合は我慢してMorletWaveletを使うか、そうでなければ別のガウシアンに依存しない
Waveletを用いるところだと思います。

この世には他にも色々なWaveletがあります。

[^goodhaar]: 計算コストとか、アルゴリズムのシンプルさとか。そもそも、用途が違うんですよね。

# フーリエ逆変換を使って算出するWavelet
実は、フーリエ逆変換すると算出されるWaveletというのが数種類発見されています。
なんて変態的な導出の仕方なんでしょう！と思います。
これらの利点は挙げろと言われると難しいのですが、
Morletと比べて真ん中が凹まないやつが発見されていますから、そこが利点かも？

例えば2000年に入ってから知られるようになった一般モールスWavelet[^morse]というWaveletがあります。
(Morseはモールスっていう読み方で正しいのかどうかは分からないので詳しい人教えて下さい)

既にこれを脳波解析に応用している論文もあります。定義は

$$\hat{\Psi}(w) = sign(\omega) \alpha_{\beta\gamma}\omega^\beta e^{-\omega^\gamma}$$

という式…ではなく、**これのフーリエ逆変換が一般モールスWavelet**です。
計算上はFFTやるならフーリエ変換の手間が省けてお得ですね！

![morse.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/139153/1f01fc38-d49a-c47f-0546-3072f2cac768.png)
MorletWaveletとそっくりです。(パラメータいじって似せました)

ちなみに、このwaveletは$\beta$と$\gamma$で調整するんですが、
$\beta$が低かったらちびまる子ちゃんの永沢君みたいに
真ん中が尖った波になります。
![super_nagasawa.png](img/nagasawa.png)

永沢君みたいなwaveletが欲しかった人には朗報なんですかね？
(周波数解像度は超絶悪くなります)
